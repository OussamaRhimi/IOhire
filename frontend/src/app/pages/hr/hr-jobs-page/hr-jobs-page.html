<section class="container container--wide hr-jobs-page">
  <div class="hr-jobs-head">
    <div>
      <h1>Job Postings Management</h1>
      <p class="muted">Create job postings and declare required skills/experience</p>
    </div>
    <div class="actions">
      <button class="btn btn--ghost" type="button" (click)="refresh()" [disabled]="loading()">Refresh</button>
      <button class="btn btn--primary hr-jobs-create-btn" type="button" (click)="openCreateModal()">
        <lucide-icon [img]="iconPlus" [size]="18" />
        <span>Create Job Posting</span>
      </button>
    </div>
  </div>

  @if (error()) {
    <div class="alert alert--error">{{ error() }}</div>
  }

  <div class="hr-jobs-list">
    @if (loading()) {
      <div class="card skeleton" style="height: 180px"></div>
      <div class="card skeleton" style="height: 180px"></div>
    } @else if (!hasJobs()) {
      <div class="alert">No job postings yet.</div>
    } @else {
      @for (job of paginatedJobs(); track (job.documentId || job.id)) {
        <article class="card hr-job-card">
          <div class="hr-job-card__top">
            <div class="truncate">
              <h2 class="hr-job-card__title">{{ job.title || 'Untitled role' }}</h2>
              <div class="hr-job-meta">
                @let meta = jobMeta(job);
                <span>{{ meta.departments.join(', ') }}</span>
                <span>&middot;</span>
                <span>{{ meta.location }}</span>
                <span>&middot;</span>
                <span>{{ meta.employmentType }}</span>
              </div>
            </div>
            <span [class]="statusClass(job.status)">{{ statusLabel(job.status) }}</span>
          </div>

          <div class="hr-job-card__mid">
            <div>
              <h3>Required Skills</h3>
              <div class="hr-job-skills">
                @for (skill of jobSkillsRequired(job); track skill) {
                  <span class="hr-job-skill">{{ skill }}</span>
                } @empty {
                  <span class="muted small">Not specified</span>
                }
              </div>
            </div>
            <div>
              <h3>Experience Required</h3>
              <p class="hr-job-experience">{{ jobExperience(job) }}</p>
            </div>
          </div>

          <div class="hr-job-card__bottom">
            <div class="hr-job-stats">
              <span><lucide-icon [img]="iconUsers" [size]="15" /> {{ applicantCount(job) }} applicants</span>
              <span><lucide-icon [img]="iconCalendar" [size]="15" /> Posted {{ postedDate(job) }}</span>
            </div>

            <div class="hr-job-actions">
              <select
                class="input input--sm"
                [value]="job.status || 'draft'"
                (change)="setStatus(job, $any($event.target).value)"
                [disabled]="saving()"
              >
                @if (statuses().length === 0) {
                  <option value="draft">Draft</option>
                  <option value="open">Open</option>
                  <option value="closed">Closed</option>
                } @else {
                  @for (s of statuses(); track s) {
                    <option [value]="s">{{ statusLabel(s) }}</option>
                  }
                }
              </select>

              <button class="btn btn--ghost hr-job-icon-btn" type="button" (click)="openEditModal(job)">
                <lucide-icon [img]="iconEdit" [size]="16" />
              </button>
              <button class="btn btn--ghost hr-job-icon-btn hr-job-icon-btn--danger" type="button" (click)="delete(job)">
                <lucide-icon [img]="iconTrash" [size]="16" />
              </button>
            </div>
          </div>
        </article>
      }
    }

    <!-- Pagination -->
    @if (totalPages() > 1) {
      <nav class="pagination">
        <div class="pagination__info muted small">
          Showing {{ (currentPage() - 1) * pageSize() + 1 }}–{{ currentPage() * pageSize() > jobs().length ? jobs().length : currentPage() * pageSize() }}
          of {{ jobs().length }}
        </div>
        <div class="pagination__controls">
          <button class="btn btn--ghost btn--sm" type="button" [disabled]="currentPage() <= 1" (click)="goToPage(currentPage() - 1)">&laquo; Prev</button>
          @for (p of pageNumbers(); track $index) {
            @if (p === '...') {
              <span class="pagination__ellipsis">…</span>
            } @else {
              <button
                class="btn btn--sm"
                [class.btn--primary]="p === currentPage()"
                [class.btn--ghost]="p !== currentPage()"
                type="button"
                (click)="goToPage(+p)"
              >{{ p }}</button>
            }
          }
          <button class="btn btn--ghost btn--sm" type="button" [disabled]="currentPage() >= totalPages()" (click)="goToPage(currentPage() + 1)">Next &raquo;</button>
        </div>
        <div class="pagination__size">
          <select class="input input--sm" [value]="pageSize()" (change)="setPageSize(+$any($event.target).value)">
            <option value="6">6 / page</option>
            <option value="12">12 / page</option>
            <option value="24">24 / page</option>
          </select>
        </div>
      </nav>
    }
  </div>
</section>

@if (showModal()) {
  <div class="hr-job-modal-backdrop" (click)="closeModal()">
    <div class="hr-job-modal card" (click)="$event.stopPropagation()">
      <div class="hr-job-modal__head">
        <h2>{{ modalTitle() }}</h2>
        <button class="btn btn--ghost hr-job-icon-btn" type="button" (click)="closeModal()">
          <lucide-icon [img]="iconClose" [size]="16" />
        </button>
      </div>

      <form class="hr-job-form" [formGroup]="createForm" (ngSubmit)="submitModal()">
        <label class="field">
          <span class="field__label">Job Title</span>
          <input class="input" formControlName="title" placeholder="e.g., Senior Frontend Developer" />
        </label>

        <div class="grid2">
          <label class="field">
            <span class="field__label">Departments</span>
            <input
              class="input"
              type="search"
              [value]="departmentQuery()"
              (input)="setDepartmentQuery($any($event.target).value)"
              (keydown.enter)="addFirstDepartmentMatch(); $event.preventDefault()"
              placeholder="Type to search departments"
            />
            <div class="hr-job-suggest-list">
              @for (name of filteredDepartmentOptions(); track name) {
                <button class="hr-job-suggest hr-job-suggest--department" type="button" (click)="addDepartment(name)">
                  {{ name }}
                </button>
              } @empty {
                <span class="muted small">No matching department.</span>
              }
            </div>
            <div class="hr-job-picked-list">
              @for (name of selectedDepartments(); track name) {
                <button class="hr-job-picked hr-job-picked--department" type="button" (click)="removeDepartment(name)">
                  <span>{{ name }}</span>
                  <span aria-hidden="true">x</span>
                </button>
              } @empty {
                <span class="muted small">No department selected.</span>
              }
            </div>
          </label>

          <label class="field">
            <span class="field__label">Location</span>
            <input class="input" formControlName="location" placeholder="e.g., Remote" />
          </label>
        </div>

        <div class="grid2">
          <label class="field">
            <span class="field__label">Type</span>
            <input class="input" formControlName="employmentType" placeholder="e.g., Full-time" />
          </label>

          <label class="field">
            <span class="field__label">Status</span>
            <select class="input" formControlName="status">
              @if (statuses().length === 0) {
                <option value="draft">Draft</option>
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              } @else {
                @for (s of statuses(); track s) {
                  <option [value]="s">{{ statusLabel(s) }}</option>
                }
              }
            </select>
          </label>
        </div>

        <label class="field">
          <span class="field__label">Required Skills</span>
          <input
            class="input"
            type="search"
            [value]="requiredSkillQuery()"
            (input)="setRequiredSkillQuery($any($event.target).value)"
            (keydown.enter)="addFirstSkillMatch('skillsRequired'); $event.preventDefault()"
            placeholder="Type to search required skills"
          />
          <div class="hr-job-suggest-list">
            @for (name of filteredSkillOptions('skillsRequired'); track name) {
              <button class="hr-job-suggest hr-job-suggest--required" type="button" (click)="addSkill('skillsRequired', name)">
                {{ name }}
              </button>
            } @empty {
              <span class="muted small">No matching required skill.</span>
            }
          </div>
          <div class="hr-job-picked-list">
            @for (name of selectedRequiredSkills(); track name) {
              <button class="hr-job-picked hr-job-picked--required" type="button" (click)="removeSkill('skillsRequired', name)">
                <span>{{ name }}</span>
                <span aria-hidden="true">x</span>
              </button>
            } @empty {
              <span class="muted small">No required skills selected.</span>
            }
          </div>
        </label>

        <div class="grid2">
          <label class="field">
            <span class="field__label">Nice-to-have Skills</span>
            <input
              class="input"
              type="search"
              [value]="niceSkillQuery()"
              (input)="setNiceSkillQuery($any($event.target).value)"
              (keydown.enter)="addFirstSkillMatch('skillsNiceToHave'); $event.preventDefault()"
              placeholder="Type to search nice-to-have skills"
            />
            <div class="hr-job-suggest-list">
              @for (name of filteredSkillOptions('skillsNiceToHave'); track name) {
                <button class="hr-job-suggest hr-job-suggest--nice" type="button" (click)="addSkill('skillsNiceToHave', name)">
                  {{ name }}
                </button>
              } @empty {
                <span class="muted small">No matching nice-to-have skill.</span>
              }
            </div>
            <div class="hr-job-picked-list">
              @for (name of selectedNiceSkills(); track name) {
                <button class="hr-job-picked hr-job-picked--nice" type="button" (click)="removeSkill('skillsNiceToHave', name)">
                  <span>{{ name }}</span>
                  <span aria-hidden="true">x</span>
                </button>
              } @empty {
                <span class="muted small">No nice-to-have skills selected.</span>
              }
            </div>
          </label>

          <label class="field">
            <span class="field__label">Experience Required</span>
            <input class="input" type="number" min="0" step="1" formControlName="minYearsExperience" placeholder="e.g., 5" />
          </label>
        </div>

        <label class="field">
          <span class="field__label">Job Description</span>
          <textarea class="input" rows="5" formControlName="description" placeholder="Describe the role and responsibilities..."></textarea>
        </label>

        <label class="field">
          <span class="field__label">Additional Notes</span>
          <textarea class="input" rows="3" formControlName="requirementsNotes" placeholder="Optional details for evaluators..."></textarea>
        </label>

        <div class="hr-job-modal__foot">
          <button class="btn btn--ghost" type="button" (click)="closeModal()" [disabled]="saving()">Cancel</button>
          <button class="btn btn--primary" type="submit" [disabled]="saving()">{{ saving() ? 'Saving...' : submitLabel() }}</button>
        </div>
      </form>
    </div>
  </div>
}
