<section class="container container--wide candidate-detail-page">
  @if (error()) {
    <div class="alert alert--error">{{ error() }}</div>
  }

  @if (loading()) {
    <div class="skeleton" style="height: 42px; width: 100%"></div>
    <div class="skeleton" style="height: 42px; width: 100%; margin-top: 10px"></div>
  } @else if (!candidate()) {
    <div class="alert">Candidate not found.</div>
  } @else {
    <div class="candidate-detail-header">
      <div>
        <h1>Parsed CV - {{ candidate()?.fullName || candidate()?.email || ('#' + candidate()?.id) }}</h1>
        <p class="muted">Automatically extracted and structured data</p>
      </div>
      <div class="actions">
        <button class="btn btn--ghost" type="button" (click)="openResume()">View Original</button>
        <button class="btn btn--primary" type="button" (click)="openStandardizedPdf()">Download Template</button>
      </div>
    </div>

    <div class="candidate-detail-grid">
      <div class="candidate-detail-main">
        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Personal Information</h2>
            <span class="candidate-check">OK</span>
          </div>
          <div class="candidate-contact-grid">
            <div>
              <div class="muted small">Full Name</div>
              <div class="strong">{{ contactInfo().fullName }}</div>
            </div>
            <div>
              <div class="muted small">Email</div>
              <div class="strong">{{ contactInfo().email }}</div>
            </div>
            <div>
              <div class="muted small">Phone</div>
              <div class="strong">{{ contactInfo().phone }}</div>
            </div>
            <div>
              <div class="muted small">Location</div>
              <div class="strong">{{ contactInfo().location }}</div>
            </div>
          </div>
        </section>

        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Professional Summary</h2>
            <span class="candidate-check">OK</span>
          </div>
          <p class="candidate-body-text">{{ summaryText() }}</p>
        </section>

        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Work Experience</h2>
            <span class="candidate-check">OK</span>
          </div>
          @if (experienceTimeline().roles.length === 0) {
            <div class="muted">No experience extracted yet.</div>
          } @else {
            <div class="candidate-stack">
              @for (r of experienceTimeline().roles; track (r.title + '-' + r.company + '-' + r.startRaw + '-' + r.endRaw)) {
                <div class="candidate-item">
                  <div class="candidate-item__icon">W</div>
                  <div>
                    <div class="strong">{{ r.title || 'Role' }}</div>
                    <div class="muted">{{ r.company || '-' }} | {{ r.startRaw || '-' }} - {{ r.endRaw || '-' }}</div>
                    @if (r.duration) {
                      <div class="small muted">Duration: {{ r.duration }}</div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </section>

        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Education</h2>
            <span class="candidate-check">OK</span>
          </div>
          @if (educationItems().length === 0) {
            <div class="muted">No education extracted yet.</div>
          } @else {
            <div class="candidate-stack">
              @for (e of educationItems(); track (e.degree + '-' + e.school + '-' + e.period)) {
                <div class="candidate-item">
                  <div class="candidate-item__icon candidate-item__icon--blue">E</div>
                  <div>
                    <div class="strong">{{ e.degree }}</div>
                    <div class="muted">{{ e.school }} | {{ e.period }}</div>
                  </div>
                </div>
              }
            </div>
          }
        </section>

        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Skills and Competencies</h2>
            <span class="candidate-check">OK</span>
          </div>
          @if (extractedSkills().length === 0) {
            <div class="muted">No skills extracted yet.</div>
          } @else {
            <div class="candidate-skill-wrap">
              @for (s of extractedSkills(); track s) {
                <span class="candidate-skill-chip">{{ s }}</span>
              }
            </div>
          }
        </section>
      </div>

      <aside class="candidate-detail-side">
        <section class="card candidate-side-card">
          <h3>CV Completeness</h3>
          <div class="candidate-score-circle">{{ candidate()?.score ?? 0 }}%</div>
          <div class="muted" style="text-align: center">Overall Score</div>

          <div class="candidate-side-group">
            <div class="strong">Present Information</div>
            @for (item of presentInfo(); track item.label) {
              @if (item.present) {
                <div class="candidate-info-row candidate-info-row--ok">{{ item.label }}</div>
              }
            }
          </div>

          <div class="candidate-side-group">
            <div class="strong">Missing Information</div>
            @if (missingInfo().length === 0) {
              <div class="candidate-info-row candidate-info-row--ok">No missing fields</div>
            } @else {
              @for (item of missingInfo(); track item.label) {
                <div class="candidate-info-row candidate-info-row--warn">{{ item.label }}</div>
              }
            }
          </div>
        </section>

        <section class="card candidate-side-card">
          <h3>File Information</h3>
          <div class="candidate-file-row">
            <div class="muted">Filename</div>
            <div class="strong">{{ candidate()?.resume?.name || '-' }}</div>
          </div>
          <div class="candidate-file-row">
            <div class="muted">Size</div>
            <div class="strong">{{ formatBytes(candidate()?.resume?.size) }}</div>
          </div>
          <div class="candidate-file-row">
            <div class="muted">Uploaded</div>
            <div class="strong">{{ formatDateTime(candidate()?.createdAt) }}</div>
          </div>
        </section>

        <section class="card candidate-side-card">
          <h3>Actions</h3>
          @if (templates().length > 0) {
            <label class="field">
              <span class="field__label">Template</span>
              <select class="input" [value]="selectedTemplateKey()" (change)="applyTemplateKey(($any($event.target).value))" [disabled]="saving()">
                @for (t of templates(); track t.key) {
                  <option [value]="t.key">{{ t.name }}</option>
                }
              </select>
            </label>
          }
          <div class="actions" style="margin-top: 10px">
            <button class="btn btn--primary" type="button" (click)="reprocess()" [disabled]="!canReprocess()">Re-run AI</button>
            <button class="btn btn--ghost" type="button" (click)="back()">Back to list</button>
          </div>
        </section>
      </aside>
    </div>
  }
</section>
