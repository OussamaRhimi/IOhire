<section class="container container--wide candidate-detail-page">
  @if (error()) {
    <div class="alert alert--error">{{ error() }}</div>
  }

  @if (loading()) {
    <div class="skeleton" style="height: 42px; width: 100%"></div>
    <div class="skeleton" style="height: 42px; width: 100%; margin-top: 10px"></div>
  } @else if (!candidate()) {
    <div class="alert">Candidate not found.</div>
  } @else {
    <div class="candidate-detail-header">
      <div>
        <h1>Parsed CV - {{ candidate()?.fullName || candidate()?.email || ('#' + candidate()?.id) }}</h1>
        <p class="muted">Automatically extracted and structured data</p>
      </div>
      <div class="actions">
        <button class="btn btn--ghost" type="button" (click)="openResume()">View Original</button>
        <button class="btn btn--primary" type="button" (click)="openStandardizedPdf()">Download Template</button>
      </div>
    </div>

    <div class="candidate-detail-grid">
      <div class="candidate-detail-main">
        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Personal Information</h2>
            <span class="candidate-check">OK</span>
          </div>
          <div class="candidate-contact-grid">
            <div>
              <div class="muted small">Full Name</div>
              <div class="strong">{{ contactInfo().fullName }}</div>
            </div>
            <div>
              <div class="muted small">Email</div>
              <div class="strong">{{ contactInfo().email }}</div>
            </div>
            <div>
              <div class="muted small">Phone</div>
              <div class="strong">{{ contactInfo().phone }}</div>
            </div>
            <div>
              <div class="muted small">Location</div>
              <div class="strong">{{ contactInfo().location }}</div>
            </div>
          </div>
        </section>

        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Professional Summary</h2>
            <span class="candidate-check">OK</span>
          </div>
          <p class="candidate-body-text">{{ summaryText() }}</p>
        </section>

        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Work Experience</h2>
            <span class="candidate-check">OK</span>
          </div>
          @if (experienceTimeline().roles.length === 0) {
            <div class="muted">No experience extracted yet.</div>
          } @else {
            <div class="candidate-stack">
              @for (r of experienceTimeline().roles; track (r.title + '-' + r.company + '-' + r.startRaw + '-' + r.endRaw)) {
                <div class="candidate-item">
                  <div class="candidate-item__icon">W</div>
                  <div>
                    <div class="strong">{{ r.title || 'Role' }}</div>
                    <div class="muted">{{ r.company || '-' }}@if (r.dateRange) { | {{ r.dateRange }}}</div>
                    @if (r.duration) {
                      <div class="small muted">Duration: {{ r.duration }}</div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </section>

        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Education</h2>
            <span class="candidate-check">OK</span>
          </div>
          @if (educationItems().length === 0) {
            <div class="muted">No education extracted yet.</div>
          } @else {
            <div class="candidate-stack">
              @for (e of educationItems(); track (e.degree + '-' + e.school + '-' + e.period)) {
                <div class="candidate-item">
                  <div class="candidate-item__icon candidate-item__icon--blue">E</div>
                  <div>
                    <div class="strong">{{ e.degree }}</div>
                    <div class="muted">{{ e.school }} | {{ e.period }}</div>
                  </div>
                </div>
              }
            </div>
          }
        </section>

        <section class="card candidate-panel">
          <div class="candidate-panel__head">
            <h2>Technical Skills</h2>
            <span class="candidate-check">OK</span>
          </div>
          @if (extractedSkills().length === 0) {
            <div class="muted">No skills extracted yet.</div>
          } @else {
            <div class="candidate-skill-wrap">
              @for (s of extractedSkills(); track s) {
                <span class="candidate-skill-chip">{{ s }}</span>
              }
            </div>
          }
        </section>

        @if (extractedCompetencies().length > 0) {
          <section class="card candidate-panel">
            <div class="candidate-panel__head">
              <h2>Competencies</h2>
              <span class="candidate-check">OK</span>
            </div>
            <div class="candidate-stack">
              @for (c of extractedCompetencies(); track c) {
                <div class="candidate-item">
                  <div class="candidate-item__icon candidate-item__icon--green">C</div>
                  <div class="strong" style="font-weight: 400">{{ c }}</div>
                </div>
              }
            </div>
          </section>
        }

        @if (candidateLinks().length > 0) {
          <section class="card candidate-panel">
            <div class="candidate-panel__head">
              <h2>Links &amp; Profiles</h2>
              <span class="candidate-check">OK</span>
            </div>
            <div class="candidate-stack">
              @for (lnk of candidateLinks(); track lnk.url) {
                <div class="candidate-item">
                  <div class="candidate-item__icon candidate-item__icon--blue">{{ lnk.icon }}</div>
                  <div>
                    <div class="strong">{{ lnk.label }}</div>
                    <a class="muted small" [href]="lnk.url" target="_blank" rel="noopener">{{ lnk.url }}</a>
                  </div>
                </div>
              }
            </div>
          </section>
        }

        <!-- Score Explanation Card -->
        @if (scoreExplanation(); as exp) {
          <section class="card candidate-panel score-explanation">
            <div class="candidate-panel__head">
              <h2>Score Explanation</h2>
              <span class="score-quality-badge score-quality-badge--{{ exp.qualityClass }}">{{ exp.qualityLabel }}</span>
            </div>

            <p class="score-explanation__formula muted small">
              Final Score = Fit Score × {{ exp.fitWeight }}% + Completeness Score × {{ exp.completenessWeight }}%
            </p>

            <!-- Score bars -->
            <div class="score-bars">
              <div class="score-bar-row">
                <div class="score-bar-label">Final Score</div>
                <div class="score-bar-track">
                  <div class="score-bar-fill score-bar-fill--final" [style.width.%]="exp.score"></div>
                </div>
                <div class="score-bar-value">{{ exp.score }}</div>
              </div>
              <div class="score-bar-row">
                <div class="score-bar-label">Fit Score</div>
                <div class="score-bar-track">
                  <div class="score-bar-fill score-bar-fill--fit" [style.width.%]="exp.fitScore"></div>
                </div>
                <div class="score-bar-value">{{ exp.fitScore }}</div>
              </div>
              <div class="score-bar-row">
                <div class="score-bar-label">Completeness</div>
                <div class="score-bar-track">
                  <div class="score-bar-fill score-bar-fill--completeness" [style.width.%]="exp.completenessScore"></div>
                </div>
                <div class="score-bar-value">{{ exp.completenessScore }}</div>
              </div>
            </div>

            <!-- Experience -->
            @if (exp.experienceYears != null) {
              <div class="score-detail-section">
                <div class="score-detail-heading">Experience</div>
                <div class="score-detail-row">
                  <span>Detected experience:</span>
                  <strong>{{ exp.experienceYears }} year{{ exp.experienceYears === 1 ? '' : 's' }}</strong>
                </div>
                @if (exp.minYears != null) {
                  <div class="score-detail-row">
                    <span>Required minimum:</span>
                    <strong>{{ exp.minYears }} year{{ exp.minYears === 1 ? '' : 's' }}</strong>
                    @if (exp.experienceMet) {
                      <span class="score-tag score-tag--ok">Met</span>
                    } @else {
                      <span class="score-tag score-tag--warn">Not met</span>
                    }
                  </div>
                }
              </div>
            }

            <!-- Required Skills -->
            @if (exp.matchedSkills.length > 0 || exp.missingSkills.length > 0) {
              <div class="score-detail-section">
                <div class="score-detail-heading">Required Skills ({{ exp.matchedSkills.length }}/{{ exp.matchedSkills.length + exp.missingSkills.length }})</div>
                @if (exp.matchedSkills.length > 0) {
                  <div class="score-chip-wrap">
                    @for (s of exp.matchedSkills; track s) {
                      <span class="score-chip score-chip--matched">{{ s }}</span>
                    }
                  </div>
                }
                @if (exp.missingSkills.length > 0) {
                  <div class="score-chip-wrap">
                    @for (s of exp.missingSkills; track s) {
                      <span class="score-chip score-chip--missing">{{ s }}</span>
                    }
                  </div>
                }
              </div>
            }

            <!-- Nice-to-Have Skills -->
            @if (exp.matchedNiceToHave.length > 0 || exp.missingNiceToHave.length > 0) {
              <div class="score-detail-section">
                <div class="score-detail-heading">Nice-to-Have Skills ({{ exp.matchedNiceToHave.length }}/{{ exp.matchedNiceToHave.length + exp.missingNiceToHave.length }})</div>
                @if (exp.matchedNiceToHave.length > 0) {
                  <div class="score-chip-wrap">
                    @for (s of exp.matchedNiceToHave; track s) {
                      <span class="score-chip score-chip--matched">{{ s }}</span>
                    }
                  </div>
                }
                @if (exp.missingNiceToHave.length > 0) {
                  <div class="score-chip-wrap">
                    @for (s of exp.missingNiceToHave; track s) {
                      <span class="score-chip score-chip--missing">{{ s }}</span>
                    }
                  </div>
                }
              </div>
            }

            <!-- Custom Criteria -->
            @if (exp.customResults.length > 0) {
              <div class="score-detail-section">
                <div class="score-detail-heading">Custom Criteria</div>
                <div class="score-chip-wrap">
                  @for (cr of exp.customResults; track cr.name) {
                    <span class="score-chip" [class.score-chip--bonus-hit]="cr.type === 'bonus' && cr.matched"
                          [class.score-chip--bonus-miss]="cr.type === 'bonus' && !cr.matched"
                          [class.score-chip--penalty-hit]="cr.type === 'penalty' && cr.matched"
                          [class.score-chip--penalty-miss]="cr.type === 'penalty' && !cr.matched">
                      {{ cr.name }}
                      @if (cr.matched) {
                        <span class="score-chip__pts">{{ cr.type === 'bonus' ? '+' : '' }}{{ cr.points }}pts</span>
                      } @else {
                        <span class="score-chip__pts">—</span>
                      }
                    </span>
                  }
                </div>
              </div>
            }

            <!-- Notes -->
            @if (exp.notes) {
              <div class="score-detail-section">
                <div class="score-detail-heading">AI Notes</div>
                <p class="score-notes">{{ exp.notes }}</p>
              </div>
            }
          </section>
        }
      </div>

      <aside class="candidate-detail-side">
        <section class="card candidate-side-card">
          <h3>CV Completeness</h3>
          <div class="candidate-score-circle">{{ candidate()?.score ?? 0 }}%</div>
          <div class="muted" style="text-align: center">Overall Score</div>

          <div class="candidate-side-group">
            <div class="strong">Present Information</div>
            @for (item of presentInfo(); track item.label) {
              @if (item.present) {
                <div class="candidate-info-row candidate-info-row--ok">{{ item.label }}</div>
              }
            }
          </div>

          <div class="candidate-side-group">
            <div class="strong">Missing Information</div>
            @if (missingInfo().length === 0) {
              <div class="candidate-info-row candidate-info-row--ok">No missing fields</div>
            } @else {
              @for (item of missingInfo(); track item.label) {
                <div class="candidate-info-row candidate-info-row--warn">{{ item.label }}</div>
              }
            }
          </div>
        </section>

        <section class="card candidate-side-card">
          <h3>File Information</h3>
          <div class="candidate-file-row">
            <div class="muted">Filename</div>
            <div class="strong">{{ candidate()?.resume?.name || '-' }}</div>
          </div>
          <div class="candidate-file-row">
            <div class="muted">Size</div>
            <div class="strong">{{ formatBytes(candidate()?.resume?.size) }}</div>
          </div>
          <div class="candidate-file-row">
            <div class="muted">Uploaded</div>
            <div class="strong">{{ formatDateTime(candidate()?.createdAt) }}</div>
          </div>
        </section>

        <section class="card candidate-side-card">
          <h3>Actions</h3>
          @if (templates().length > 0) {
            <label class="field">
              <span class="field__label">Template</span>
              <select class="input" [value]="selectedTemplateKey()" (change)="applyTemplateKey(($any($event.target).value))" [disabled]="saving()">
                @for (t of templates(); track t.key) {
                  <option [value]="t.key">{{ t.name }}</option>
                }
              </select>
            </label>
          }
          <div class="actions" style="margin-top: 10px">
            <button class="btn btn--primary" type="button" (click)="reprocess()" [disabled]="!canReprocess()">Re-run AI</button>
            <button class="btn btn--ghost" type="button" (click)="back()">Back to list</button>
          </div>
        </section>
      </aside>
    </div>
  }
</section>
