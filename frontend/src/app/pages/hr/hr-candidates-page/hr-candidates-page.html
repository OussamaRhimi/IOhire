<section class="container container--wide candidate-list-page">
  <div class="candidate-list-header">
    <div>
      <h1>Candidates Portal</h1>
      <p class="muted">CV upload portal with parsed profiles and optional filtering.</p>
    </div>
    <div class="actions">
      <a class="btn btn--ghost" routerLink="/admin/hr/jobs">Jobs</a>
      <button class="btn btn--ghost" type="button" (click)="refresh()" [disabled]="loading()">Refresh</button>
    </div>
  </div>

  @if (error()) {
    <div class="alert alert--error">{{ error() }}</div>
  }

  <div class="card candidate-toolbar" [formGroup]="filterForm">
    <div class="candidate-search-row">
      <input class="input candidate-search-input" formControlName="q" placeholder="Search by name, email, or position..." />
      <div class="actions actions--right">
        <button class="btn candidate-filter-btn" type="button" (click)="toggleFilters()">Filters</button>
        <button class="btn btn--ghost candidate-filter-btn" type="button" (click)="resetFilters()">Clear</button>
      </div>
    </div>

    @if (showFilters()) {
      <div class="candidate-filter-panel">
        <div class="grid2">
          <label class="field">
            <span class="field__label">Status</span>
            <select class="input" formControlName="status">
              <option value="">All</option>
              @for (s of statusOptions(); track s) {
                <option [value]="s">{{ s }}</option>
              }
            </select>
          </label>
        </div>

        <label class="field">
          <span class="field__label">Search criterion</span>
          <div class="candidate-filter-columns">
            @for (col of searchColumns; track col.key) {
              <label class="candidate-filter-chip">
                <input
                  type="radio"
                  name="searchScope"
                  [checked]="filterForm.controls.searchScope.value === col.key"
                  (change)="setSearchScope(col.key)"
                />
                <span>{{ col.label }}</span>
              </label>
            }
          </div>
        </label>
      </div>
    }
  </div>

  <div style="margin-top: 14px">
    @if (loading()) {
      <div class="skeleton" style="height: 42px; width: 100%"></div>
      <div class="skeleton" style="height: 42px; width: 100%; margin-top: 10px"></div>
    } @else if (filtered().length === 0) {
      <div class="alert">No candidates match the current filter.</div>
    } @else {
      <div class="table table--candidates-modern">
        <div class="table__head">
          <div>Candidate</div>
          <div>Position</div>
          <div>Submitted</div>
          <div>Status</div>
          <div>Match score</div>
          <div>Actions</div>
        </div>
        @for (c of filtered(); track (c.documentId || c.id)) {
          <div class="table__row">
            <div>
              <div class="strong" style="font-size: 18px">{{ c.fullName || '-' }}</div>
              <div class="muted">{{ c.email || '' }}</div>
            </div>
            <div>{{ c.jobTitle || '-' }}</div>
            <div class="muted">{{ formatDateShort(c.createdAt) }}</div>
            <div>
              <span class="candidate-status" [class]="'candidate-status ' + statusClass(c.status)">{{ statusLabel(c.status) }}</span>
              <select
                class="input input--sm candidate-status-select"
                [value]="c.status || ''"
                (change)="saveStatus(c, $any($event.target).value)"
                [disabled]="saving() || statusOptions().length === 0"
              >
                <option value="">-</option>
                @for (s of statusOptions(); track s) {
                  <option [value]="s">{{ s }}</option>
                }
              </select>
            </div>
            <div>
              @if (c.score == null) {
                <span class="muted">-</span>
              } @else {
                <div class="candidate-score">
                  <div class="candidate-score__bar">
                    <span class="candidate-score__fill" [class]="'candidate-score__fill ' + scoreClass(c.score)" [style.width.%]="c.score"></span>
                  </div>
                  <span class="strong">{{ c.score }}%</span>
                </div>
              }
            </div>
            <div class="candidate-actions-cell">
              <button class="candidate-link-btn" type="button" (click)="view(c)">View</button>
              <button class="candidate-link-btn" type="button" (click)="openResume(c)">View CV</button>
              <button class="candidate-link-btn" type="button" (click)="openStandardizedPdf(c)">Template</button>
            </div>
          </div>
        }
      </div>
    }
  </div>
</section>
