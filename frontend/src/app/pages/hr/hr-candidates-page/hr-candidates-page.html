<section class="container container--wide candidate-list-page">
  <div class="candidate-list-header">
    <div>
      <h1>Candidates Portal</h1>
      <p class="muted">CV upload portal with parsed profiles and optional filtering.</p>
    </div>
    <div class="actions">
      <a class="btn btn--ghost" routerLink="/admin/hr/jobs">Jobs</a>
      <button class="btn btn--ghost" type="button" (click)="refresh()" [disabled]="loading()">Refresh</button>
    </div>
  </div>

  @if (error()) {
    <div class="alert alert--error">{{ error() }}</div>
  }

  <div class="card candidate-toolbar" [formGroup]="filterForm">
    <div class="candidate-search-row">
      <input class="input candidate-search-input" formControlName="q" placeholder="Search by name, email, or position..." />
      <div class="actions actions--right">
        <button class="btn candidate-filter-btn" type="button" (click)="toggleFilters()">Filters</button>
        <button class="btn btn--ghost candidate-filter-btn" type="button" (click)="resetFilters()">Clear</button>
      </div>
    </div>

    @if (showFilters()) {
      <div class="candidate-filter-panel">
        <div class="candidate-filter-grid">
          <label class="field candidate-filter-field">
            <span class="field__label">Status</span>
            <select class="input candidate-filter-input" formControlName="status">
              <option value="">All</option>
              @for (s of statusOptions(); track s) {
                <option [value]="s">{{ s }}</option>
              }
            </select>
          </label>

          <div class="field candidate-filter-field candidate-score-filter">
            <div class="candidate-score-filter__head">
              <span class="field__label">Score filter</span>
              <label class="candidate-score-filter__toggle">
                <input type="checkbox" formControlName="scoreEnabled" />
                <span>Apply</span>
              </label>
            </div>

            <div
              class="candidate-score-filter__controls"
              [class.candidate-score-filter__controls--disabled]="!filterForm.controls.scoreEnabled.value"
            >
              <div class="candidate-score-filter__radios">
                <label
                  class="candidate-score-filter__radio"
                  [class.candidate-score-filter__radio--active]="filterForm.controls.scoreOperator.value === 'gt'"
                >
                  <input
                    type="radio"
                    formControlName="scoreOperator"
                    value="gt"
                    [disabled]="!filterForm.controls.scoreEnabled.value"
                  />
                  <span>Above</span>
                </label>

                <label
                  class="candidate-score-filter__radio"
                  [class.candidate-score-filter__radio--active]="filterForm.controls.scoreOperator.value === 'lt'"
                >
                  <input
                    type="radio"
                    formControlName="scoreOperator"
                    value="lt"
                    [disabled]="!filterForm.controls.scoreEnabled.value"
                  />
                  <span>Below</span>
                </label>
              </div>

              <div class="candidate-score-filter__range-row">
                <input
                  class="candidate-score-filter__range"
                  type="range"
                  min="0"
                  max="100"
                  step="1"
                  formControlName="scoreThreshold"
                  [disabled]="!filterForm.controls.scoreEnabled.value"
                />
                <span class="candidate-score-filter__value">{{ filterForm.controls.scoreThreshold.value }}%</span>
              </div>
            </div>
          </div>

          <label class="field candidate-filter-field">
            <span class="field__label">Open job</span>
            <select class="input candidate-filter-input" formControlName="jobId">
              <option value="">All open jobs</option>
              @for (job of openJobs(); track job.id) {
                <option [value]="job.id">{{ job.title }}</option>
              }
            </select>
          </label>
        </div>

        <label class="field">
          <span class="field__label">Search criterion</span>
          <div class="candidate-filter-columns">
            @for (col of searchColumns; track col.key) {
              <label class="candidate-filter-chip">
                <input
                  type="radio"
                  name="searchScope"
                  [checked]="filterForm.controls.searchScope.value === col.key"
                  (change)="setSearchScope(col.key)"
                />
                <span>{{ col.label }}</span>
              </label>
            }
          </div>
        </label>
      </div>
    }
  </div>

  <div style="margin-top: 14px">
    @if (loading()) {
      <div class="skeleton" style="height: 42px; width: 100%"></div>
      <div class="skeleton" style="height: 42px; width: 100%; margin-top: 10px"></div>
    } @else if (filtered().length === 0) {
      <div class="alert">No candidates match the current filter.</div>
    } @else {
      <div class="card candidate-bulk-toolbar">
        <div class="muted small">
          {{ selectedCount() }} selected out of {{ filtered().length }} filtered candidates
        </div>
        <div class="actions">
          <button class="btn btn--ghost btn--sm" type="button" (click)="selectAllFiltered()" [disabled]="saving() || filtered().length === 0">
            Select filtered
          </button>
          <button class="btn btn--ghost btn--sm" type="button" (click)="clearSelection()" [disabled]="saving() || selectedCount() === 0">
            Clear selection
          </button>
          <select
            class="input input--sm candidate-bulk-status"
            [value]="bulkStatus()"
            (change)="setBulkStatus($any($event.target).value)"
            [disabled]="saving() || selectedCount() === 0"
          >
            <option value="">Set status...</option>
            @for (s of statusOptions(); track s) {
              <option [value]="s">{{ statusLabel(s) }}</option>
            }
          </select>
          <button
            class="btn btn--primary btn--sm"
            type="button"
            (click)="applyBulkStatus()"
            [disabled]="saving() || selectedCount() === 0 || !bulkStatus()"
          >
            Apply to selected
          </button>
        </div>
      </div>

      <div class="table table--candidates-modern">
        <div class="table__head">
          <div class="candidate-select-cell">
            <input
              type="checkbox"
              class="candidate-row-check"
              [checked]="allFilteredSelected()"
              [indeterminate]="partlyFilteredSelected()"
              (change)="toggleSelectAllFiltered($any($event.target).checked)"
              [disabled]="saving() || filtered().length === 0"
              aria-label="Select all filtered candidates"
            />
          </div>
          <div>Candidate</div>
          <div>Position</div>
          <div>Submitted</div>
          <div>Status</div>
          <div>Match score</div>
          <div>Actions</div>
        </div>
        @for (c of filtered(); track (c.documentId || c.id)) {
          <div class="table__row">
            <div class="candidate-select-cell">
              <input
                type="checkbox"
                class="candidate-row-check"
                [checked]="isSelected(c.id)"
                (change)="toggleCandidateSelection(c.id, $any($event.target).checked)"
                [disabled]="saving()"
                aria-label="Select candidate"
              />
            </div>
            <div>
              <div class="strong" style="font-size: 18px">{{ c.fullName || '-' }}</div>
              <div class="muted">{{ c.email || '' }}</div>
            </div>
            <div>{{ c.jobTitle || '-' }}</div>
            <div class="muted">{{ formatDateShort(c.createdAt) }}</div>
            <div>
              <span class="candidate-status" [class]="'candidate-status ' + statusClass(c.status)">{{ statusLabel(c.status) }}</span>
              <select
                class="input input--sm candidate-status-select"
                [value]="c.status || ''"
                (change)="saveStatus(c, $any($event.target).value)"
                [disabled]="saving() || statusOptions().length === 0"
              >
                <option value="">-</option>
                @for (s of statusOptions(); track s) {
                  <option [value]="s">{{ s }}</option>
                }
              </select>
            </div>
            <div>
              @if (c.score == null) {
                <span class="muted">-</span>
              } @else {
                <div class="candidate-score">
                  <div class="candidate-score__bar">
                    <span class="candidate-score__fill" [class]="'candidate-score__fill ' + scoreClass(c.score)" [style.width.%]="c.score"></span>
                  </div>
                  <span class="strong">{{ c.score }}%</span>
                </div>
              }
            </div>
            <div class="candidate-actions-cell">
              <button class="candidate-link-btn" type="button" (click)="view(c)">View</button>
            </div>
          </div>
        }
      </div>
    }
  </div>
</section>
