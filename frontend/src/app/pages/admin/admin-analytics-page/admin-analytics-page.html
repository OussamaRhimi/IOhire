<section class="container container--wide analytics-page">
  <div class="analytics-head analytics-fade">
    <div>
      <h1>Analytics</h1>
      <p class="muted">Clear metrics and trends for hiring pipeline health.</p>
    </div>
    <div class="actions">
      <button class="btn btn--ghost analytics-refresh-btn" type="button" (click)="refresh()" [disabled]="loading()">
        <lucide-icon [img]="iconRefresh" [size]="16" />
        <span>Refresh</span>
      </button>
    </div>
  </div>

  @if (error()) {
    <div class="alert alert--error">{{ error() }}</div>
  }

  @if (loading()) {
    <div class="skeleton" style="height: 42px; width: 100%; margin-top: 12px"></div>
    <div class="skeleton" style="height: 240px; width: 100%; margin-top: 12px"></div>
  } @else {
    <div class="analytics-grid analytics-grid--lead">
      <div class="card analytics-kpi-wrap" appRevealOnScroll>
        <div class="header-row">
          <div>
            <div class="strong">KPIs</div>
            <div class="muted small">Last refreshed: {{ formatDateTime(lastRefreshedAt()) }}</div>
          </div>
        </div>

        <div class="analytics-kpi-grid">
          <div class="analytics-kpi">
            <div class="analytics-kpi__icon"><lucide-icon [img]="iconJobs" [size]="16" /></div>
            <div class="kpi__label">Open jobs</div>
            <div class="kpi__value">{{ kpi().openJobs }}</div>
            <div class="kpi__hint muted small">of {{ kpi().totalJobs }} total</div>
          </div>

          <div class="analytics-kpi">
            <div class="analytics-kpi__icon"><lucide-icon [img]="iconCandidates" [size]="16" /></div>
            <div class="kpi__label">Candidates</div>
            <div class="kpi__value">{{ kpi().totalCandidates }}</div>
            <div class="kpi__hint muted small">in pipeline</div>
          </div>

          <div class="analytics-kpi">
            <div class="analytics-kpi__icon"><lucide-icon [img]="iconActivity" [size]="16" /></div>
            <div class="kpi__label">Processed</div>
            <div class="kpi__value">{{ kpi().processed }}</div>
            <div class="kpi__hint muted small">Processing: {{ kpi().processing }} · Errors: {{ kpi().error }}</div>
          </div>

          <div class="analytics-kpi">
            <div class="analytics-kpi__icon"><lucide-icon [img]="iconTarget" [size]="16" /></div>
            <div class="kpi__label">Avg score</div>
            <div class="kpi__value">{{ kpi().avgScore ?? '—' }}</div>
            <div class="kpi__hint muted small">out of 100</div>
          </div>

          <div class="analytics-kpi">
            <div class="analytics-kpi__icon"><lucide-icon [img]="iconClock" [size]="16" /></div>
            <div class="kpi__label">Avg processing</div>
            <div class="kpi__value">{{ kpi().avgProcessingMinutes ?? '—' }}</div>
            <div class="kpi__hint muted small">minutes (approx.)</div>
          </div>
        </div>
      </div>

      <div class="card analytics-chart-card" appRevealOnScroll [revealDelay]="80">
        <div class="analytics-card-head">
          <div>
            <div class="strong">Candidates submitted (last 14 days)</div>
            <div class="muted small">Trend line</div>
          </div>
          <span class="analytics-card-icon"><lucide-icon [img]="iconChart" [size]="16" /></span>
        </div>
        <div class="analytics-chart-h">
          <canvas #chartCandidatesByDay></canvas>
        </div>
      </div>
    </div>

    <div class="analytics-grid">
      <div class="card analytics-chart-card" appRevealOnScroll>
        <div class="analytics-card-head">
          <div>
            <div class="strong">Candidates by status</div>
            <div class="muted small">Doughnut</div>
          </div>
        </div>
        <div class="analytics-chart-h">
          <canvas #chartCandidatesByStatus></canvas>
        </div>
      </div>

      <div class="card analytics-chart-card" appRevealOnScroll [revealDelay]="90">
        <div class="analytics-card-head">
          <div>
            <div class="strong">Jobs by status</div>
            <div class="muted small">Pie</div>
          </div>
        </div>
        <div class="analytics-chart-h">
          <canvas #chartJobsByStatus></canvas>
        </div>
      </div>
    </div>

    <div class="analytics-grid">
      <div class="card analytics-chart-card" appRevealOnScroll>
        <div class="analytics-card-head">
          <div>
            <div class="strong">Score distribution</div>
            <div class="muted small">Histogram</div>
          </div>
        </div>
        <div class="analytics-chart-h">
          <canvas #chartScoreHistogram></canvas>
        </div>
      </div>

      <div class="card analytics-chart-card" appRevealOnScroll [revealDelay]="90">
        <div class="analytics-card-head">
          <div>
            <div class="strong">Candidates per job (top)</div>
            <div class="muted small">Bar</div>
          </div>
        </div>
        <div class="analytics-chart-h">
          <canvas #chartCandidatesByJob></canvas>
        </div>
      </div>
    </div>

    <div class="card analytics-chart-card" appRevealOnScroll>
      <div class="analytics-card-head">
        <div>
          <div class="strong">Top missing fields</div>
          <div class="muted small">What candidates most often forget</div>
        </div>
      </div>
      <div class="analytics-chart-h analytics-chart-h--tall">
        <canvas #chartMissingFields></canvas>
      </div>
    </div>

    <!-- ============================================================= -->
    <!--  Job Posting Comparison                                        -->
    <!-- ============================================================= -->
    <div class="cmp-section" appRevealOnScroll [revealDelay]="120">
      <div class="cmp-header">
        <div class="cmp-header__title">
          <span class="cmp-header__icon"><lucide-icon [img]="iconCompare" [size]="18" /></span>
          <div>
            <h2>Compare Job Postings</h2>
            <p class="muted small">Select two job postings to compare candidate quality side-by-side.</p>
          </div>
        </div>
      </div>

      <div class="cmp-selectors">
        <div class="cmp-select-wrap">
          <label class="cmp-label cmp-label--a" for="cmpJobA">Job A</label>
          <select id="cmpJobA" class="cmp-select" [ngModel]="compareJobA() ?? ''" (ngModelChange)="onCompareJobChange('A', $event)">
            <option value="">— Select a job posting —</option>
            @for (job of comparableJobs(); track job.id) {
              <option [value]="job.id" [disabled]="job.id === compareJobB()">{{ job.title ?? 'Untitled' }}</option>
            }
          </select>
        </div>
        <span class="cmp-vs">vs</span>
        <div class="cmp-select-wrap">
          <label class="cmp-label cmp-label--b" for="cmpJobB">Job B</label>
          <select id="cmpJobB" class="cmp-select" [ngModel]="compareJobB() ?? ''" (ngModelChange)="onCompareJobChange('B', $event)">
            <option value="">— Select a job posting —</option>
            @for (job of comparableJobs(); track job.id) {
              <option [value]="job.id" [disabled]="job.id === compareJobA()">{{ job.title ?? 'Untitled' }}</option>
            }
          </select>
        </div>
      </div>

      @if (compareReady()) {
        @if (cmpData(); as cmp) {
          <!-- KPI comparison cards -->
          <div class="cmp-kpi-row">
            <div class="cmp-kpi-card cmp-kpi-card--a">
              <div class="cmp-kpi-card__label">{{ cmp.titleA }}</div>
              <div class="cmp-kpi-card__grid">
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.countA }}</span><span class="cmp-kpi-item__lbl">Candidates</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.avgA }}</span><span class="cmp-kpi-item__lbl">Avg Score</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.medianA }}</span><span class="cmp-kpi-item__lbl">Median</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.pctAbove60A }}%</span><span class="cmp-kpi-item__lbl">≥ 60</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.pctAbove80A }}%</span><span class="cmp-kpi-item__lbl">≥ 80</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.shortlistedPctA }}%</span><span class="cmp-kpi-item__lbl">Shortlisted</span></div>
              </div>
            </div>
            <div class="cmp-kpi-card cmp-kpi-card--b">
              <div class="cmp-kpi-card__label">{{ cmp.titleB }}</div>
              <div class="cmp-kpi-card__grid">
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.countB }}</span><span class="cmp-kpi-item__lbl">Candidates</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.avgB }}</span><span class="cmp-kpi-item__lbl">Avg Score</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.medianB }}</span><span class="cmp-kpi-item__lbl">Median</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.pctAbove60B }}%</span><span class="cmp-kpi-item__lbl">≥ 60</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.pctAbove80B }}%</span><span class="cmp-kpi-item__lbl">≥ 80</span></div>
                <div class="cmp-kpi-item"><span class="cmp-kpi-item__val">{{ cmp.shortlistedPctB }}%</span><span class="cmp-kpi-item__lbl">Shortlisted</span></div>
              </div>
            </div>
          </div>

          <!-- Charts row 1 -->
          <div class="analytics-grid">
            <div class="card analytics-chart-card">
              <div class="analytics-card-head">
                <div>
                  <div class="strong">Score distribution (overlay)</div>
                  <div class="muted small">Histogram comparison</div>
                </div>
              </div>
              <div class="analytics-chart-h"><canvas #chartCmpScoreHist></canvas></div>
            </div>
            <div class="card analytics-chart-card">
              <div class="analytics-card-head">
                <div>
                  <div class="strong">Score metrics</div>
                  <div class="muted small">Average, median &amp; percentages</div>
                </div>
              </div>
              <div class="analytics-chart-h"><canvas #chartCmpScoreBox></canvas></div>
            </div>
          </div>

          <!-- Charts row 2 -->
          <div class="analytics-grid">
            <div class="card analytics-chart-card">
              <div class="analytics-card-head">
                <div>
                  <div class="strong">Status breakdown</div>
                  <div class="muted small">Candidates per status</div>
                </div>
              </div>
              <div class="analytics-chart-h"><canvas #chartCmpStatus></canvas></div>
            </div>
            <div class="card analytics-chart-card">
              <div class="analytics-card-head">
                <div>
                  <div class="strong">Quality radar</div>
                  <div class="muted small">Multi-dimensional quality comparison</div>
                </div>
              </div>
              <div class="analytics-chart-h"><canvas #chartCmpRadar></canvas></div>
            </div>
          </div>

          <!-- Charts row 3 -->
          <div class="card analytics-chart-card">
            <div class="analytics-card-head">
              <div>
                <div class="strong">Missing fields comparison</div>
                <div class="muted small">Top fields candidates are missing</div>
              </div>
            </div>
            <div class="analytics-chart-h analytics-chart-h--tall"><canvas #chartCmpMissing></canvas></div>
          </div>
        }
      } @else {
        <div class="cmp-placeholder">
          <lucide-icon [img]="iconCompare" [size]="32" />
          <p>Select two different job postings above to see comparative charts.</p>
        </div>
      }
    </div>
  }
</section>
